<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Zip Workbench | McIndi WebUtils</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.css"
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <style>
      :root {
        --bg: #f3f1ed;
        --ink: #111418;
        --muted: #626a73;
        --panel: #fbf7f2;
        --stroke: #e2d8cf;
        --accent: #c6562a;
        --accent-soft: rgba(198, 86, 42, 0.16);
        --warn: #b9382e;
        --brand-deep: #0f1720;
        --brand-fade: rgba(15, 23, 32, 0.08);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Manrope", "Segoe UI", "Helvetica Neue", Arial, sans-serif;
        color: var(--ink);
        background: radial-gradient(900px 600px at 10% -10%, #f6d9c4 0%, transparent 60%),
          radial-gradient(700px 500px at 120% 10%, #d4e9e5 0%, transparent 60%),
          var(--bg);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      header {
        width: 100%;
        padding: 24px 28px 10px;
        display: grid;
        gap: 10px;
      }

      .brand-bar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        flex-wrap: wrap;
      }

      .brand-link {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        text-decoration: none;
        color: var(--brand-deep);
        font-weight: 700;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        font-size: 0.75rem;
      }

      .brand-mark {
        width: 30px;
        height: 30px;
        border-radius: 9px;
        background: var(--brand-deep);
        color: #fff;
        display: grid;
        place-items: center;
        font-weight: 700;
        font-size: 0.8rem;
        box-shadow: 0 10px 20px var(--brand-fade);
      }

      .brand-subtitle {
        font-size: 0.9rem;
        color: var(--muted);
      }

      header h1 {
        margin: 0;
        font-family: "Fraunces", "Iowan Old Style", "Palatino", serif;
        font-size: clamp(1.8rem, 4vw, 2.6rem);
      }

      header p {
        margin: 0;
        color: var(--muted);
      }

      .toolbar {
        width: 100%;
        padding: 0 28px 12px;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
      }

      .toolbar input[type="file"] {
        display: none;
      }

      .toolbar label,
      .toolbar button,
      .toolbar a {
        border: 1px solid var(--stroke);
        background: #fff;
        padding: 8px 14px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        text-decoration: none;
        color: var(--ink);
      }

      .toolbar .primary {
        background: var(--accent);
        border-color: var(--accent);
        color: #fff;
      }

      .toolbar .danger {
        color: var(--warn);
        border-color: var(--warn);
      }

      .toolbar .status {
        margin-left: auto;
        color: var(--muted);
        font-size: 0.9rem;
      }

      .workspace {
        width: 100%;
        flex: 1;
        padding: 0 20px 24px;
        display: grid;
        grid-template-columns: 280px 1fr;
        gap: 16px;
        min-height: 0;
      }

      .pane {
        background: var(--panel);
        border: 1px solid var(--stroke);
        border-radius: 16px;
        padding: 14px;
        min-height: 0;
        display: flex;
        flex-direction: column;
      }

      .pane h2 {
        margin: 0 0 12px;
        font-size: 1rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--muted);
      }

      .pane-toolbar {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 10px;
      }

      .pane-toolbar button {
        border: 1px solid var(--stroke);
        background: #fff;
        padding: 6px 10px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.85rem;
      }

      .pane-toolbar .primary {
        background: var(--accent);
        border-color: var(--accent);
        color: #fff;
      }

      .tree {
        list-style: none;
        margin: 0;
        padding: 0;
        display: grid;
        gap: 6px;
        font-size: 0.95rem;
        overflow: auto;
      }

      .tree li {
        display: grid;
        gap: 6px;
      }

      .tree-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }

      .tree-entry {
        border: none;
        background: none;
        text-align: left;
        padding: 6px 8px;
        border-radius: 8px;
        color: var(--ink);
        font: inherit;
        flex: 1;
      }

      button.tree-entry {
        cursor: pointer;
      }

      .tree-entry.file:hover,
      .tree-entry.file.active {
        background: var(--accent-soft);
        color: var(--accent);
        font-weight: 600;
      }

      .tree-entry.folder {
        font-weight: 600;
        color: var(--muted);
        cursor: default;
      }

      .delete-link {
        border: none;
        background: none;
        color: var(--warn);
        font: inherit;
        padding: 4px 6px;
        cursor: pointer;
        border-radius: 6px;
      }

      .delete-link:hover {
        background: rgba(185, 56, 46, 0.12);
      }

      .tree .nested {
        padding-left: 14px;
        border-left: 1px dashed var(--stroke);
      }

      .editor-header {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
        margin-bottom: 10px;
      }

      .editor-header .path {
        font-weight: 600;
      }

      .editor-header .hint {
        color: var(--muted);
        font-size: 0.9rem;
      }

      textarea {
        width: 100%;
        min-height: 0;
        border-radius: 12px;
        border: 1px solid var(--stroke);
        padding: 12px;
        font: 0.95rem/1.5 "Consolas", "Courier New", monospace;
        background: #fff;
        resize: vertical;
      }

      .CodeMirror {
        min-height: 0;
        height: 100%;
        border: 1px solid var(--stroke);
        border-radius: 12px;
        font: 0.95rem/1.5 "Consolas", "Courier New", monospace;
        background: #fff;
      }

      .empty {
        color: var(--muted);
        line-height: 1.6;
        flex: 1;
      }

      dialog {
        border: none;
        border-radius: 16px;
        padding: 0;
        width: min(520px, 92vw);
        box-shadow: 0 20px 40px rgba(31, 31, 31, 0.25);
      }

      dialog::backdrop {
        background: rgba(31, 31, 31, 0.35);
      }

      .confirm-form {
        padding: 18px;
        display: grid;
        gap: 10px;
      }

      .confirm-form h3 {
        margin: 0;
        font-size: 1.1rem;
      }

      .confirm-form p {
        margin: 0;
        color: var(--muted);
        line-height: 1.5;
      }

      .confirm-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }

      .confirm-actions button {
        border: 1px solid var(--stroke);
        background: #fff;
        padding: 8px 14px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
      }

      .confirm-actions .primary {
        background: var(--warn);
        border-color: var(--warn);
        color: #fff;
      }

      .dialog-form {
        padding: 18px;
        display: grid;
        gap: 12px;
      }

      .dialog-form h3 {
        margin: 0;
        font-size: 1.1rem;
      }

      .dialog-form label {
        font-weight: 600;
        font-size: 0.9rem;
      }

      .dialog-form input,
      .dialog-form select {
        width: 100%;
        padding: 8px 10px;
        border-radius: 10px;
        border: 1px solid var(--stroke);
        font: inherit;
      }

      .dialog-form .hint {
        color: var(--muted);
        font-size: 0.85rem;
      }

      .dialog-form .error {
        color: var(--warn);
        font-size: 0.85rem;
      }

      footer {
        padding: 12px 28px 24px;
        color: var(--muted);
        font-size: 0.85rem;
      }

      footer a {
        color: inherit;
        text-decoration: none;
        font-weight: 600;
      }

      @media (max-width: 900px) {
        .workspace {
          grid-template-columns: 1fr;
          padding: 0 16px 20px;
        }

        header,
        .toolbar {
          padding-left: 16px;
          padding-right: 16px;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="brand-bar">
        <a class="brand-link" href="https://www.mcindi.com" target="_blank" rel="noopener">
          <span class="brand-mark">M</span>
          McIndi Solutions
        </a>
        <div class="brand-subtitle">WebUtils â€¢ Zip Workbench</div>
      </div>
      <h1>Zip Workbench</h1>
      <p>Inspect, edit, and re-download a ZIP file entirely in your browser.</p>
    </header>

    <div class="toolbar">
      <label class="primary" for="zip-input">Upload ZIP</label>
      <input id="zip-input" type="file" accept=".zip" />
      <a id="download-link" href="#" download="archive.zip">Download ZIP</a>
      <button id="clear-zip" class="danger" type="button">Clear ZIP</button>
      <a href="index.html">Back to index</a>
      <span class="status" id="status">No ZIP loaded.</span>
    </div>

    <section class="workspace">
      <aside class="pane">
        <h2>Files</h2>
        <div class="pane-toolbar">
          <button class="primary" type="button" id="new-file">New File</button>
          <button type="button" id="new-folder">New Folder</button>
        </div>
        <div id="tree-container" class="empty">Upload a ZIP to see its contents.</div>
      </aside>
      <main class="pane">
        <h2>Editor</h2>
        <div id="editor-area" class="empty">Select a file to edit its contents.</div>
      </main>
    </section>

    <footer>
      Built by <a href="https://www.mcindi.com" target="_blank" rel="noopener">McIndi Solutions LLC</a>.
    </footer>

    <dialog id="confirm-dialog">
      <form method="dialog" class="confirm-form">
        <h3 id="confirm-title">Confirm action</h3>
        <p id="confirm-message">Are you sure you want to continue?</p>
        <div class="confirm-actions">
          <button value="cancel" type="submit">Cancel</button>
          <button value="confirm" type="submit" class="primary" id="confirm-accept">
            Confirm
          </button>
        </div>
      </form>
    </dialog>

    <dialog id="create-dialog">
      <form method="dialog" class="dialog-form" id="create-form">
        <h3 id="create-title">Create</h3>
        <div>
          <label for="create-name">Name</label>
          <input id="create-name" name="name" autocomplete="off" />
        </div>
        <div>
          <label for="create-parent">Parent folder</label>
          <select id="create-parent" name="parent"></select>
        </div>
        <div class="hint" id="create-hint">Use / to nest folders.</div>
        <div class="error" id="create-error" role="alert"></div>
        <div class="confirm-actions">
          <button value="cancel" type="submit">Cancel</button>
          <button value="confirm" type="submit" class="primary" id="create-accept">
            Create
          </button>
        </div>
      </form>
    </dialog>

    <script src="https://cdn.jsdelivr.net/npm/fflate@0.8.2/umd/index.js"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.js"
      integrity="sha512-8RnEqURPUc5aqFEN04aQEiPlSAdE0jlFS/9iGgUyNtwFnSKCXhmB6ZTNl7LnDtDWKabJIASzXrzD0K+LYexU9g=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/javascript/javascript.min.js"
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/xml/xml.min.js"
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/css/css.min.js"
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/htmlmixed/htmlmixed.min.js"
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/markdown/markdown.min.js"
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script>
      const STORAGE_KEY_V1 = "webutils.zip-workbench.v1";
      const STORAGE_KEY_V2 = "webutils.zip-workbench.v2";
      const zipInput = document.getElementById("zip-input");
      const downloadLink = document.getElementById("download-link");
      const clearButton = document.getElementById("clear-zip");
      const treeContainer = document.getElementById("tree-container");
      const editorArea = document.getElementById("editor-area");
      const statusEl = document.getElementById("status");
      const newFileButton = document.getElementById("new-file");
      const newFolderButton = document.getElementById("new-folder");
      const confirmDialog = document.getElementById("confirm-dialog");
      const confirmTitle = document.getElementById("confirm-title");
      const confirmMessage = document.getElementById("confirm-message");
      const confirmAccept = document.getElementById("confirm-accept");
      const createDialog = document.getElementById("create-dialog");
      const createForm = document.getElementById("create-form");
      const createTitle = document.getElementById("create-title");
      const createName = document.getElementById("create-name");
      const createParent = document.getElementById("create-parent");
      const createHint = document.getElementById("create-hint");
      const createError = document.getElementById("create-error");
      const createAccept = document.getElementById("create-accept");

      const textDecoder = new TextDecoder("utf-8");
      const textEncoder = new TextEncoder();

      let confirmResolve = null;
      let persistTimer = null;
      let editorInstance = null;
      let downloadUrl = null;

      const state = {
        files: new Map(),
        folders: new Set(),
        selectedPath: null,
        zipName: "archive.zip",
        zipBytes: null,
      };

      let createMode = "file";

      const requestConfirmation = ({ title, message, confirmText }) => {
        if (!confirmDialog || typeof confirmDialog.showModal !== "function") {
          return Promise.resolve(window.confirm(message || title));
        }
        confirmTitle.textContent = title;
        confirmMessage.textContent = message;
        confirmAccept.textContent = confirmText || "Confirm";
        return new Promise((resolve) => {
          confirmResolve = resolve;
          confirmDialog.showModal();
        });
      };

      confirmDialog.addEventListener("close", () => {
        if (!confirmResolve) {
          return;
        }
        const confirmed = confirmDialog.returnValue === "confirm";
        confirmResolve(confirmed);
        confirmResolve = null;
      });

      const toBase64 = (bytes) => {
        let binary = "";
        const chunkSize = 0x8000;
        for (let i = 0; i < bytes.length; i += chunkSize) {
          binary += String.fromCharCode(...bytes.subarray(i, i + chunkSize));
        }
        return btoa(binary);
      };

      const fromBase64 = (value) => {
        const binary = atob(value);
        const bytes = new Uint8Array(binary.length);
        for (let i = 0; i < binary.length; i += 1) {
          bytes[i] = binary.charCodeAt(i);
        }
        return bytes;
      };

      const isTextData = (data) => {
        const sample = data.subarray(0, 2000);
        for (const byte of sample) {
          if (byte === 0) {
            return false;
          }
        }
        return true;
      };

      const setStatus = (text) => {
        statusEl.textContent = text;
      };

      const revokeDownloadUrl = () => {
        if (downloadUrl) {
          URL.revokeObjectURL(downloadUrl);
          downloadUrl = null;
        }
      };

      const clearWorkspace = () => {
        state.files.clear();
        state.folders.clear();
        state.selectedPath = null;
        state.zipBytes = null;
        revokeDownloadUrl();
        treeContainer.textContent = "Upload a ZIP to see its contents.";
        treeContainer.className = "empty";
        editorArea.textContent = "Select a file to edit its contents.";
        editorArea.className = "empty";
        downloadLink.setAttribute("href", "#");
        downloadLink.setAttribute("download", "archive.zip");
        setStatus("No ZIP loaded.");
      };

      const normalizePath = (value) => {
        return value.replace(/\\/g, "/").replace(/\/+/g, "/").trim();
      };

      const addImplicitFolders = (path) => {
        const parts = path.split("/");
        let current = "";
        for (let i = 0; i < parts.length - 1; i += 1) {
          current = current ? `${current}/${parts[i]}` : parts[i];
          state.folders.add(current);
        }
      };

      const buildTree = (paths, folders) => {
        const root = {};
        folders.forEach((path) => {
          const parts = path.split("/");
          let current = root;
          parts.forEach((part, index) => {
            if (!current[part]) {
              current[part] = { __children: {}, __isFile: false, __isFolder: true };
            }
            if (index === parts.length - 1) {
              current[part].__isFolder = true;
            }
            current = current[part].__children;
          });
        });
        paths.forEach((path) => {
          const parts = path.split("/");
          let current = root;
          parts.forEach((part, index) => {
            if (!current[part]) {
              current[part] = { __children: {}, __isFile: index === parts.length - 1 };
            }
            if (index === parts.length - 1) {
              current[part].__isFile = true;
            }
            current = current[part].__children;
          });
        });
        return root;
      };

      const renderTree = () => {
        const paths = Array.from(state.files.keys()).sort();
        const folders = Array.from(state.folders.values()).sort();
        if (paths.length === 0 && folders.length === 0) {
          treeContainer.textContent = "This ZIP has no files or folders.";
          treeContainer.className = "empty";
          return;
        }
        treeContainer.className = "";

        const root = buildTree(paths, folders);

        const createList = (node, prefix = "") => {
          const list = document.createElement("ul");
          list.className = "tree";
          Object.keys(node).forEach((key) => {
            const entry = node[key];
            const item = document.createElement("li");
            const currentPath = prefix ? `${prefix}/${key}` : key;
            const row = document.createElement("div");
            row.className = "tree-row";

            if (entry.__isFile) {
              const button = document.createElement("button");
              button.textContent = key;
              button.className = `tree-entry file ${
                state.selectedPath === currentPath ? "active" : ""
              }`;
              button.addEventListener("click", () => selectFile(currentPath));
              row.appendChild(button);
            } else {
              const label = document.createElement("div");
              label.textContent = key;
              label.className = "tree-entry folder";
              row.appendChild(label);
            }

            const deleteButton = document.createElement("button");
            deleteButton.className = "delete-link";
            deleteButton.type = "button";
            deleteButton.textContent = "Delete";
            deleteButton.addEventListener("click", async (event) => {
              event.stopPropagation();
              if (entry.__isFile) {
                await deleteFile(currentPath);
              } else {
                await deleteFolder(currentPath);
              }
            });
            row.appendChild(deleteButton);
            item.appendChild(row);

            const children = Object.keys(entry.__children || {});
            if (children.length > 0) {
              const nested = createList(entry.__children, currentPath);
              nested.classList.add("nested");
              item.appendChild(nested);
            }

            list.appendChild(item);
          });
          return list;
        };

        treeContainer.innerHTML = "";
        treeContainer.appendChild(createList(root));
      };

      const renderEditor = () => {
        if (editorInstance) {
          editorInstance.toTextArea();
          editorInstance = null;
        }
        editorArea.innerHTML = "";
        if (!state.selectedPath) {
          editorArea.textContent = "Select a file to edit its contents.";
          editorArea.className = "empty";
          return;
        }

        const fileEntry = state.files.get(state.selectedPath);
        if (!fileEntry) {
          editorArea.textContent = "File not found.";
          editorArea.className = "empty";
          return;
        }

        const header = document.createElement("div");
        header.className = "editor-header";

        const pathEl = document.createElement("div");
        pathEl.className = "path";
        pathEl.textContent = state.selectedPath;

        const hint = document.createElement("div");
        hint.className = "hint";

        header.append(pathEl, hint);

        if (!fileEntry.isText) {
          hint.textContent = "Binary file: editing disabled.";
          editorArea.append(header);
          return;
        }

        hint.textContent = "Changes auto-save into the ZIP.";

        const textarea = document.createElement("textarea");
        textarea.value = fileEntry.text;
        editorArea.append(header, textarea);
        editorArea.className = "";

        editorInstance = CodeMirror.fromTextArea(textarea, {
          lineNumbers: true,
          lineWrapping: true,
          mode: getModeForPath(state.selectedPath),
        });

        editorInstance.on("change", (cm) => {
          fileEntry.text = cm.getValue();
          fileEntry.data = textEncoder.encode(fileEntry.text);
          schedulePersist();
        });
      };

      const getModeForPath = (path) => {
        const lower = path.toLowerCase();
        if (lower.endsWith(".js") || lower.endsWith(".mjs") || lower.endsWith(".cjs")) {
          return "javascript";
        }
        if (lower.endsWith(".json")) {
          return { name: "javascript", json: true };
        }
        if (lower.endsWith(".html") || lower.endsWith(".htm")) {
          return "htmlmixed";
        }
        if (lower.endsWith(".css")) {
          return "css";
        }
        if (lower.endsWith(".md") || lower.endsWith(".markdown")) {
          return "markdown";
        }
        if (lower.endsWith(".xml") || lower.endsWith(".svg")) {
          return "xml";
        }
        return null;
      };

      const updateDownloadLink = () => {
        if (!state.zipBytes) {
          revokeDownloadUrl();
          downloadLink.setAttribute("href", "#");
          return;
        }
        revokeDownloadUrl();
        const blob = new Blob([state.zipBytes], { type: "application/zip" });
        downloadUrl = URL.createObjectURL(blob);
        downloadLink.href = downloadUrl;
        downloadLink.download = state.zipName || "archive.zip";
      };

      const persistZip = () => {
        if (state.files.size === 0 && state.folders.size === 0) {
          localStorage.removeItem(STORAGE_KEY_V2);
          return;
        }

        const zipInputData = {};
        state.folders.forEach((path) => {
          zipInputData[`${path}/`] = new Uint8Array(0);
        });
        state.files.forEach((entry, path) => {
          zipInputData[path] = entry.data;
        });

        state.zipBytes = fflate.zipSync(zipInputData, { level: 6 });
        updateDownloadLink();
        try {
          const payload = {
            zipBase64: toBase64(state.zipBytes),
            zipName: state.zipName,
            folders: Array.from(state.folders.values()).sort(),
          };
          localStorage.setItem(STORAGE_KEY_V2, JSON.stringify(payload));
          const folderCount = state.folders.size;
          const fileCount = state.files.size;
          const folderLabel = folderCount === 1 ? "folder" : "folders";
          const fileLabel = fileCount === 1 ? "file" : "files";
          setStatus(`Loaded ${fileCount} ${fileLabel}, ${folderCount} ${folderLabel}.`);
        } catch (error) {
          setStatus("Storage full. Download the ZIP to keep changes.");
        }
      };

      const schedulePersist = () => {
        if (persistTimer) {
          clearTimeout(persistTimer);
        }
        persistTimer = setTimeout(() => {
          persistZip();
          persistTimer = null;
        }, 600);
      };

      const loadZipBytes = (bytes) => {
        const entries = fflate.unzipSync(bytes);
        state.files.clear();
        state.folders.clear();
        Object.keys(entries).forEach((path) => {
          const data = entries[path];
          if (path.endsWith("/")) {
            const folderPath = path.slice(0, -1);
            if (folderPath) {
              state.folders.add(folderPath);
            }
            return;
          }
          const isText = isTextData(data);
          state.files.set(path, {
            data,
            isText,
            text: isText ? textDecoder.decode(data) : "",
          });
          addImplicitFolders(path);
        });

        state.selectedPath = null;
        renderTree();
        renderEditor();
        persistZip();
      };

      const selectFile = (path) => {
        state.selectedPath = path;
        renderTree();
        renderEditor();
      };

      const getFolderOptions = () => {
        const folders = new Set(state.folders.values());
        state.files.forEach((_, path) => addImplicitFolders(path));
        return Array.from(folders.values()).sort();
      };

      const openCreateDialog = (mode) => {
        createMode = mode;
        createTitle.textContent = mode === "file" ? "Create new file" : "Create new folder";
        createAccept.textContent = mode === "file" ? "Create file" : "Create folder";
        createHint.textContent = mode === "file"
          ? "Use / to nest folders, for example docs/readme.md."
          : "Use / to create nested folders, for example docs/assets.";
        createError.textContent = "";
        createName.value = "";
        createParent.innerHTML = "";
        const rootOption = document.createElement("option");
        rootOption.value = "";
        rootOption.textContent = "(root)";
        createParent.appendChild(rootOption);
        getFolderOptions().forEach((path) => {
          const option = document.createElement("option");
          option.value = path;
          option.textContent = path;
          createParent.appendChild(option);
        });
        if (state.selectedPath) {
          const parts = state.selectedPath.split("/");
          if (parts.length > 1) {
            createParent.value = parts.slice(0, -1).join("/");
          }
        }
        if (typeof createDialog.showModal === "function") {
          createDialog.showModal();
          createName.focus();
          return;
        }
        const fallbackName = window.prompt(
          mode === "file" ? "New file name" : "New folder name",
          ""
        );
        if (fallbackName) {
          createEntry(mode, fallbackName, "");
        }
      };

      const makePath = (parent, name) => {
        const trimmed = normalizePath(name);
        const cleaned = trimmed.replace(/^\/+|\/+$/g, "");
        if (!cleaned) {
          return "";
        }
        return parent ? `${parent}/${cleaned}` : cleaned;
      };

      const createEntry = async (mode, name, parent) => {
        const path = makePath(parent, name);
        if (!path) {
          createError.textContent = "Enter a valid name.";
          return;
        }
        if (mode === "file") {
          if (state.folders.has(path)) {
            createError.textContent = "A folder already exists at that path.";
            return;
          }
          if (state.files.has(path)) {
            const confirmed = await requestConfirmation({
              title: "Overwrite existing file?",
              message: `This will replace ${path} with a new empty file.`,
              confirmText: "Overwrite",
            });
            if (!confirmed) {
              return;
            }
          }
          const data = textEncoder.encode("");
          state.files.set(path, { data, isText: true, text: "" });
          addImplicitFolders(path);
          state.selectedPath = path;
          renderTree();
          renderEditor();
        } else {
          if (state.files.has(path) || state.folders.has(path)) {
            createError.textContent = "That path already exists.";
            return;
          }
          state.folders.add(path);
          renderTree();
        }
        schedulePersist();
        createDialog.close("confirm");
      };

      const deleteFile = async (path) => {
        const confirmed = await requestConfirmation({
          title: "Delete this file?",
          message: `This will remove ${path} from the ZIP.`,
          confirmText: "Delete file",
        });
        if (!confirmed) {
          return;
        }
        state.files.delete(path);
        if (state.selectedPath === path) {
          state.selectedPath = null;
        }
        renderTree();
        renderEditor();
        schedulePersist();
      };

      const deleteFolder = async (path) => {
        const descendantPrefix = `${path}/`;
        const fileCount = Array.from(state.files.keys()).filter((key) =>
          key.startsWith(descendantPrefix)
        ).length;
        const folderCount = Array.from(state.folders.values()).filter((key) =>
          key === path || key.startsWith(descendantPrefix)
        ).length;
        const confirmed = await requestConfirmation({
          title: "Delete this folder?",
          message: `This will remove ${folderCount} folder${
            folderCount === 1 ? "" : "s"
          } and ${fileCount} file${fileCount === 1 ? "" : "s"}.`,
          confirmText: "Delete folder",
        });
        if (!confirmed) {
          return;
        }
        Array.from(state.files.keys()).forEach((key) => {
          if (key.startsWith(descendantPrefix)) {
            state.files.delete(key);
          }
        });
        Array.from(state.folders.values()).forEach((key) => {
          if (key === path || key.startsWith(descendantPrefix)) {
            state.folders.delete(key);
          }
        });
        if (state.selectedPath && state.selectedPath.startsWith(descendantPrefix)) {
          state.selectedPath = null;
        }
        renderTree();
        renderEditor();
        schedulePersist();
      };

      const handleUpload = (file) => {
        if (!file) {
          return;
        }
        state.zipName = file.name || "archive.zip";
        const reader = new FileReader();
        reader.onload = () => {
          const buffer = reader.result;
          loadZipBytes(new Uint8Array(buffer));
        };
        reader.readAsArrayBuffer(file);
      };

      zipInput.addEventListener("change", (event) => {
        const file = event.target.files[0];
        if (file) {
          handleUpload(file);
        }
        zipInput.value = "";
      });

      newFileButton.addEventListener("click", () => openCreateDialog("file"));
      newFolderButton.addEventListener("click", () => openCreateDialog("folder"));

      createForm.addEventListener("submit", (event) => {
        event.preventDefault();
        const submitValue = event.submitter ? event.submitter.value : "confirm";
        if (submitValue === "cancel") {
          createDialog.close("cancel");
          return;
        }
        createEntry(createMode, createName.value, createParent.value);
      });

      clearButton.addEventListener("click", async () => {
        const confirmed = await requestConfirmation({
          title: "Clear the current ZIP?",
          message: "This will remove the ZIP from the app and clear saved data.",
          confirmText: "Clear ZIP",
        });
        if (!confirmed) {
          return;
        }
        localStorage.removeItem(STORAGE_KEY_V2);
        localStorage.removeItem(STORAGE_KEY_V1);
        clearWorkspace();
      });

      const loadFromStorage = () => {
        const storedV2 = localStorage.getItem(STORAGE_KEY_V2);
        if (storedV2) {
          try {
            const payload = JSON.parse(storedV2);
            const bytes = fromBase64(payload.zipBase64 || "");
            state.zipName = payload.zipName || "archive.zip";
            loadZipBytes(bytes);
            return;
          } catch (error) {
            clearWorkspace();
            return;
          }
        }

        const storedV1 = localStorage.getItem(STORAGE_KEY_V1);
        if (!storedV1) {
          clearWorkspace();
          return;
        }
        try {
          const bytes = fromBase64(storedV1);
          state.zipName = "archive.zip";
          loadZipBytes(bytes);
          schedulePersist();
        } catch (error) {
          clearWorkspace();
        }
      };

      loadFromStorage();
    </script>
  </body>
</html>
